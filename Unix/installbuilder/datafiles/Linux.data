%Variables
PF:           'Linux'
SERVICE_CTL:  '/opt/omi/bin/service_control'

%Files
/opt/omi/bin/support/installssllinks;         ../scripts/installssllinks;            755; root; ${{ROOT_GROUP_NAME}}
/opt/omi/bin/support/omiserverd.systemd;      ../installbuilder/service_scripts/omiserverd.systemd; 755; root; ${{ROOT_GROUP_NAME}}
/etc/init.d/omiserverd;	                      ../installbuilder/service_scripts/omiserverd.placeholder; 755; root; ${{ROOT_GROUP_NAME}}; conffile
/opt/omi/bin/service_control;                 ../installbuilder/service_scripts/service_control.linux; 755; root; ${{ROOT_GROUP_NAME}}

%Directories
/opt/omi/bin/support;                    755; root; ${{ROOT_GROUP_NAME}}

%OmiService_funcs
StopOmiService() {
    ${{SERVICE_CTL}} stop
}

RemoveOmiService() {
    # Stop the server if it's running
    if [ -f ${{SERVICE_CTL}} ]; then
        StopOmiService
    elif [ -f /opt/omi/bin/omiserver ]; then
        /opt/omi/bin/omiserver -s > /dev/null 2> /dev/null
    fi

    # Registered as a systemd service?
    if [ -f /usr/lib/systemd/system/omiserverd.service ]; then
        echo "Unconfiguring OMI (systemd) service ..."
        /usr/bin/systemctl disable omiserverd
        rm -f /usr/lib/systemd/system/omiserverd.service
        /usr/bin/systemctl daemon-reload
    elif [ -f /etc/init.d/omiserverd ]; then
        echo "Unconfiguring OMI service ..."
        if [ -f /usr/sbin/update-rc.d ]; then
            /usr/sbin/update-rc.d -f omiserverd remove
        elif [ -x /usr/lib/lsb/remove_initd ]; then
            /usr/lib/lsb/remove_initd /etc/init.d/omiserverd
        elif [ -x /sbin/chkconfig ]; then
            chkconfig --del omiserverd > /dev/null
        else
            echo "Unrecognized Service Controller to unregister OMI Service."
            exit 1
        fi

        rm /etc/init.d/omiserverd
    fi
}

ConfigureOmiService() {
    echo "Configuring OMI service ..."
    pidof systemd 1> /dev/null 2> /dev/null
    if [ $? -eq 0 ]; then
        # systemd
        cp /opt/omi/bin/support/omiserverd.systemd /usr/lib/systemd/system/omiserverd.service
        /usr/bin/systemctl daemon-reload
        /usr/bin/systemctl enable omiserverd
    else
        cp /opt/omi/bin/support/omiserverd /etc/init.d/omiserverd

        if [ -x /usr/sbin/update-rc.d ]; then
            update-rc.d omiserverd defaults > /dev/null
        elif [ -x /usr/lib/lsb/install_initd ]; then
            /usr/lib/lsb/install_initd /etc/init.d/omiserverd
        elif [ -x /sbin/chkconfig ]; then
            chkconfig --add omiserverd > /dev/null
        else
            echo "Unrecognized Service Controller to configure OMI Service."
            exit 1
        fi
    fi

    ${{SERVICE_CTL}} start
}

%Preinstall_10
# If our service is already running, stop it
if [ -f ${{SERVICE_CTL}} ]; then
   ${{SERVICE_CTL}} stop
fi

%Postinstall_950
#include OmiService_funcs

# Be certain that SSL linkages exist for OMI utilities
/opt/omi/bin/support/installssllinks

RemoveOmiService
ConfigureOmiService

%Preuninstall_10
#include OmiService_funcs
StopOmiService

%Postuninstall_100
#include OmiService_funcs

if ${{PERFORMING_UPGRADE_NOT}}; then
    RemoveOmiService

    rm -f /opt/omi/lib/libcrypto* /opt/omi/lib/libssl*
    rmdir /opt/omi/lib > /dev/null 2>&1
    rmdir /opt/omi > /dev/null 2>&1
    rmdir /opt > /dev/null 2>&1
fi
